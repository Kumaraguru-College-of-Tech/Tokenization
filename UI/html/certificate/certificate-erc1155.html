<!-- 
    Author       : Sandhiya S and Ramaguru R
    Date Created : 02.01.2021
    Date Updated : 14.04.2021
-->


<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Degree Certificate ERC1155</title>
	<link rel="stylesheet" href="fonts/material-icon/css/material-design-iconic-font.min.css">
	<link rel="stylesheet" href="../../css/style.css">
	<script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
			background: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)), url(https://i.ytimg.com/vi/OUF6Cc_7qwM/maxresdefault.jpg) no-repeat center center fixed;
			background-size: cover;
			color: black;
			font-family: "open sans";
			height: 100vh;
			display: flex;
			flex-direction: column;
			justify-content: space-between;

			font-family: "Trebuchet MS", Helvetica, sans-serif;
			font-size: 15px;
			letter-spacing: 2px;
			word-spacing: 2px;
			color: #000000;
			font-weight: 800;
			font-style: normal;
			font-variant: normal;
			text-transform: capitalize;
		}
		select.custom {
			appearance: none;
			-moz-appearance: none;
			-webkit-appearance: none;
			position: relative;
			padding: 0.3em 0.5em 0.3em 0.5em;
			font-size: 16px;
			line-height: 1.5;
			border-radius: 1em;
			background-repeat: no-repeat;
		}

		select.custom.gradient {
			color: black;
			text-shadow: none;
			background-color: white;
			border-color: rgb(49, 4, 4);
			background-image: linear-gradient(45deg, transparent 50%, #381605 0%),
				linear-gradient(135deg, #291003 50%, transparent 0%),
				linear-gradient(#ffffff, #ffffff);
			background-position: right 12px bottom 15px, right 6px bottom 15px, center;
			background-repeat: no-repeat;
			background-size: 6px 6px, 6px 6px, cover;
		}

		input[readonly] {
			background-color: rgba(76, 65, 65, 0.102) !important;
		}
	</style>
</head>

<body>

	<header>
		<div>
			<img src="../../images/certificate-logo.png" style="height:40px; width:40px;" />
			&nbsp;<h3>Coimbatore University</h3>
		</div>
		<nav>
			<ul>
				<li><a href="../index.html">Home</a></li>
				<li><a href="certificate-usecase.html">Back</a></li>
			</ul>
		</nav>
	</header>

	<div class="main">

		<!-- Certificate Issue -->
		<section class="issue">
			<div class="container">
				<div class="issue-content" id="issueDiv">
					<div class="issue-form" style="width:80%;">
						<h2 class="form-title">Issue Degree Certificate</h2>
						<form class="issue-form" id="issue-form">

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:format-list-numbered"
										data-inline="false"></span></label>
								<input type="number" min="1" id="tokenID" placeholder="Certificate ID" />
							</div>

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:account"
										data-inline="false"></span></label>
								<input type="text" id="name" placeholder="Holder Name" />
							</div>

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:account"
										data-inline="false"></span></label>
								<input type="text" id="hid" placeholder="Holder ID" />
							</div>

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:balance"
										data-inline="false"></span></label>&nbsp;&nbsp;
								<!-- <input type="text" id="inst" placeholder="Institution Name" /> -->
								<select class='custom gradient' id="inst">
									<option value="Kumaraguru College of Technology" selected>Kumaraguru College of
										Technology</option>
									<option value="Sri Ramakrishna College of Engineering">Sri Ramakrishna College of
										Engineering</option>
									<option value="Sri Krishna Institute of Technology">Sri Krishna Institute of
										Technology</option>
									<option value="PSG College of Technology">PSG College of Technology</option>
								</select>
							</div>

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:assignment-check"
										data-inline="false"></span></label>&nbsp;&nbsp;
								<!-- <input type="text" id="dept" placeholder="Department (eg: B.E. Civil Engineering)" /> -->
								<select class='custom gradient' id="dept">
									<option value="Computer Science and Engineering">Computer Science and Engineering
									</option>
									<option value="Information Technology">Information Technology</option>
									<option value="Electronic and Communication Engineering">Electronic and
										Communication Engineering</option>
									<option value="Mechanical Engineering">Mechanical Engineering</option>
								</select>
							</div>

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:equalizer"
										data-inline="false"></span></i></label>
								<input type="text" id="cls" placeholder="Classification (eg: First Class)" />
							</div>

							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:shield-check"
										data-inline="false"></span></label>
								<input type="text" id="address" placeholder="Holder Wallet Address" />
							</div>
							
							<div class="form-group">
								<label><span class="iconify" data-icon="zmdi:photo-size-select-large"
										data-inline="false"></span>Certificate Photocopy</label>
								<input type="file" id="img" placeholder="Upload Certificate" accept="image/*"
									style="padding-left:45%;">
							</div>

							<div class="form-group">

								<label><b>Date of Issue</b></label>
								<br><br><input type="date" id="issdate" placeholder="Date of Issue"
									style="width:45%;" />
							</div>


							<div class="btn">
								<input type="button" onclick="issue_cert()" value="Issue Certificate" style="width:25%;
								background-color: #03fc6f;
								border: 2px solid;
								border-radius: 0.6em;
								font-family: Trebuchet MS, Helvetica, sans-serif;
								color: white;
								padding: 10px 15px;
								text-decoration: none;
								margin: 4px 2px;
								cursor: pointer;
								color: #fff;
								box-shadow: 0 0 40px 40px #3498db inset, 0 0 0 0 #3498db;
								-webkit-transition: all 150ms ease-in-out;
								transition: all 150ms ease-in-out;" />
							</div>
							<h4> Transaction ID: <div id="fresult" style="color:green;">Nil</div>
								<h4 id="etherScanLink" style="display:none;">
									<a href="https://ropsten.etherscan.io/" target="_blank">Click here to verify in
										EtherScan</a>
								</h4>
								<div style="float:right;color:#0f7536;">
									<b>Want to modify an issued certificate?</b>
									<div class="btn">
										<input type="button" onclick="show_modify()" value="Modify Certificate" style="width:65%;
								background-color: #521c94;
								border: 2px solid;
								border-radius: 0.6em;
								font-family: Trebuchet MS, Helvetica, sans-serif;
								color: white;
								padding: 10px 15px;
								text-decoration: none;
								margin: 4px 2px;
								cursor: pointer;
								color: #fff;
								box-shadow: 0 0 40px 40px #3498db inset, 0 0 0 0 #3498db;
								-webkit-transition: all 150ms ease-in-out;
								transition: all 150ms ease-in-out;" />
									</div>
								</div>
						</form>
					</div>
				</div>
				<!--<div class="issue-image" style="width:20%;">
                        <figure ><img src="https://upload.wikimedia.org/wikipedia/en/thumb/4/49/Anna_University_Logo.svg/1200px-Anna_University_Logo.svg.png" alt="kct logo"></figure>
			<div class="form-group">
                                Total Certificates Issued : 
                        <div id="tsupply" style="color:green;font-weight:bolder;"/> 
                        </div>
			</div> -->

				<!-- Modify Certificate -->
				<div class="modify-content" id="modifyDiv" style="padding-right:80px;display:none;">
					<div class="modify-form">
						<h2 class="form-title">Modify Certificate</h2>
						<form class="register-form">
							<div class="form-group">
								<table>
									<tr>
										<td><input type="number" min="1" id="mtokenID"
												placeholder="Enter Certificate ID" style="font-size:19px;" /></td>
										<!-- <td><input type="button" class="iconify" data-icon="zmdi:search"
												style="height:5%;width:7%" onclick="getdetails()" /></td> -->
										<td>
											<div class="btn">
												<input type="button" onclick="getdetails()" value="Get Details" style="
																	background-color: #06806ec7;
																	border: 2px solid;
																	font-family: Trebuchet MS, Helvetica, sans-serif;
																	border-radius: 0.6em;
																	color: white;
																	padding: 10px 15px;
																	text-decoration: none;
																	margin: 4px 2px;
																	cursor: pointer;
																	color: #fff;
																	box-shadow: 0 0 40px 40px #3498db inset, 0 0 0 0 #3498db;
																	-webkit-transition: all 150ms ease-in-out;
																	transition: all 150ms ease-in-out;" />
											</div>
										</td>
									</tr>
								</table>
							</div>
							<div>
								<table>
									<tr>
										<td id="msg2" style="color:blue;font-weight:bold;"></td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;"> <b>Name :</b> <input type="text"
												id="mname" /></td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Holder ID :</b> <input
												type="text" id="mid" /> </td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Institution :</b> <input
												type="text" id="minst" readonly /> </td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Department :</b> <input
												type="text" id="mdept" readonly /></td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Classification :</b>
											<input type="text" id="mcls" readonly />
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Date of Issue :</b>
											<input type="date" id="missdate" readonly />
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Holder Wallet Address
												:</b> <input type="text" id="mholder" readonly /></td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b> Certificate Photocopy IPFS ID:</b> <input
											type="text" id="mimg" readonly/></td>
									</tr>
									<tr>
										<td style="width:50%;height:20px;padding-top:15px;"> <b>Reason to Modify
												:</b> <input type="textarea" id="mreason" /></td>
									</tr>
								</table>
							</div><br><br>

							<div class="btn">
								<input type="button" onclick="modify_cert()" value="Modify Certificate" style="width:25%;
								background-color: #03fc6f;
								border: 2px solid;
								font-family: Trebuchet MS, Helvetica, sans-serif;
								border-radius: 0.6em;
								color: white;
								padding: 10px 15px;
								text-decoration: none;
								margin: 4px 2px;
								cursor: pointer;
								color: #fff;
								box-shadow: 0 0 40px 40px #3498db inset, 0 0 0 0 #3498db;
								-webkit-transition: all 150ms ease-in-out;
								transition: all 150ms ease-in-out;" />
							</div>
							<h4> Transaction ID: <div id="mresult" style="color:green;">Nil</div>
							</h4>
							<h4 id="etherScanLink2" style="display:none;">
								<a href="https://ropsten.etherscan.io/" target="_blank">Click here to verify in
									EtherScan</a>
							</h4>
							<div style="float:right; padding:60px;color:#0f7536;">
								<b>Want to issue a new certificate?</b>
								<div class="btn">
									<input type="button" onclick="show_issue()" value="Issue Certificate" style="width:65%;
								background-color: #521c94;
								border: 2px solid;
								font-family: Trebuchet MS, Helvetica, sans-serif;
								border-radius: 0.6em;
								color: white;
								padding: 10px 15px;
								text-decoration: none;
								margin: 4px 2px;
								cursor: pointer;
								color: #fff;
								box-shadow: 0 0 40px 40px #3498db inset, 0 0 0 0 #3498db;
								-webkit-transition: all 150ms ease-in-out;
								transition: all 150ms ease-in-out;" />
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</section>


		<!-- Verify Certificate Details -->
		<section class="retrieve">
			<div class="container">
				<div class="retrieve-content">
					<div class="retrieve-image">
						<figure><img src="../../images/certificate-view1.png" alt="verify image"></figure>
					</div>

					<div class="retrieve-form" style="width:290%;">
						<h2 class="form-title">Verify Certificate</h2>
						<form class="register-form">
							<div class="form-group">
								<label for="your_name"><span class="iconify" data-icon="zmdi:labels"
										data-inline="false"></span></label>
								<input type="number" min="1" id="tokenIDd" placeholder="Certificate ID" />
							</div>
							<div class="btn">
								<input type="button" onclick="view_certdetails()" value="View Certificate" style="width:45%;
								background-color: #a8203c;
								border: 2px solid;
								font-family: Trebuchet MS, Helvetica, sans-serif;
								border-radius: 0.6em;
								color: white;
								padding: 10px 15px;
								text-decoration: none;
								margin: 4px 2px;
								cursor: pointer;
								color: #fff;
								box-shadow: 0 0 40px 40px #3498db inset, 0 0 0 0 #3498db;
								-webkit-transition: all 150ms ease-in-out;
								transition: all 150ms ease-in-out;" />
							</div>
							<div>
								<table>
									<tr>
										<td>
											<div id="msg" style="color:blue;font-weight:bold;">
											</div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> Name : <div id="cname" style="color:green;">
											</div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> ID : <div id="cid" style="color:green;">
											</div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> Institution : <div id="cinst"
												style="color:green;">
											</div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> Department : <div id="cdept"
												style="color:green;">
											</div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> Classification : <div id="ccls"
												style="color:green;"></div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> Date of Issue : <div id="cissdate"
												style="color:green;"></div>
										</td>
									</tr>
									<tr>
										<td style="width:50%;height:30px;"> Holder Wallet Address : <div id="cholder"
												style="color:green;"></div>
										</td>
									</tr>
									
								</table>
							</div><br>

						</form>
					</div>
				</div>
			</div>
		</section>
	</div>

	<!-- JS -->
	<script src="vendor/jquery/jquery.min.js"></script>
	<script src="../../js/main.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.js"></script>
	<script>

		var account;
		window.addEventListener('load', async () => {


			if (typeof window.ethereum !== 'undefined') {
				console.log("MetaMask is Available :) !");
			}

			// Modern DApp browsers
			if (window.ethereum) {
				window.web3 = new Web3(ethereum);

				// To prevent the page reloading when the MetaMask network changes
				ethereum.autoRefreshOnNetworkChange = false;

				// To Capture the account details from MetaMask
				const accounts = await ethereum.enable();
				account = accounts[0];

			}

			// Legacy DApp browsers
			else if (window.web3) {
				//window.web3 = new Web3(web3.currentProvider);
				window.web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/v3/cbd9dc11b30147e9a2cc974be655ef7c"));
			}

			// Non-DApp browsers
			else {
				console.log('Non-Ethereum browser detected. Please install MetaMask');
			}


		});


		// Function to call the "Issue Certificate" in Deployed Smart Contract
		function issue_cert() {

			console.log("Issuing College degree Certificate");

			//Instantiate and connect to contract address via ABI
			var myContract = new web3.eth.Contract(cert_abi2, cert_contractAddress2, { from: account, gasPrice: '2000000000', gas: '625048' });

			var name = document.getElementById("name").value;
			var hid = document.getElementById("hid").value;
			var dept = document.getElementById("dept").value;
			var inst = document.getElementById("inst").value;
			var issdate = document.getElementById("issdate").value;
			var cls = document.getElementById("cls").value;
			var address = document.getElementById("address").value;
			var tokenID = document.getElementById("tokenID").value;


			//call the "issue certificate" function
			var result = myContract.methods.issueCert(tokenID, name, hid, dept, inst, cls, issdate, address).send(function (err, result) {

				if (err) {
					console.log(err);
					document.getElementById("fresult").innerHTML = "Nil";
					swal({
						title: "Oops!",
						text: "Certificate cannot be issued!",
						icon: "warning",
					});
				}

				if (result) {
					var showLink = document.getElementById("etherScanLink");
					showLink.style.display = "block";
					document.getElementById("fresult").innerHTML = result;
					swal({
						title: "Great!",
						text: "Certificate Details sent to Blockchain!",
						icon: "success",
					});
				}
			});

		}

		// Functions to show and hide appropiate div 
		function show_issue() {

			var modifyDiv = document.getElementById("modifyDiv");
			modifyDiv.style.display = "none";
			var issueDiv = document.getElementById("issueDiv");
			issueDiv.style.display = "block";

		}

		function show_modify() {

			var issueDiv = document.getElementById("issueDiv");
			issueDiv.style.display = "none";
			var modifyDiv = document.getElementById("modifyDiv");
			modifyDiv.style.display = "block";

		}

		// Functions to call the "View Details" in Deployed Smart Contract
		function view_certdetails() {

			console.log("Getting College degree Certificate Details");

			//Instantiate and connect to contract address via ABI
			var myContract = new web3.eth.Contract(cert_abi2, cert_contractAddress2, { from: account, gasPrice: '2000000000', gas: '300000' });

			var tokenID = document.getElementById("tokenIDd").value;

			//call the "view certificate" function
			var result = myContract.methods.retrieveCert(tokenID).call(function (err, result) {

				if (err) { console.log(err); }
				if (result) {

					document.getElementById("cname").innerHTML = result[0];
					document.getElementById("cid").innerHTML = result[1];
					document.getElementById("cdept").innerHTML = result[2];
					document.getElementById("cinst").innerHTML = result[3];
					document.getElementById("ccls").innerHTML = result[4];
					document.getElementById("cissdate").innerHTML = result[5];
					document.getElementById("cholder").innerHTML = result[6];
					if (result[6] == "0x0000000000000000000000000000000000000000") {
						document.getElementById("msg").innerHTML = "No Certificate is issued with the given ID!";
					}
					else {
						document.getElementById("msg").innerHTML = "Here is the details!";
					}
				}

			});

		}

		function getdetails() {

			console.log("Getting College degree Certificate Details");

			//Instantiate and connect to contract address via ABI
			var myContract = new web3.eth.Contract(cert_abi2, cert_contractAddress2, { from: account, gasPrice: '2000000000', gas: '300000' });

			var tokenID = document.getElementById("mtokenID").value;

			//call the "view certificate" function
			var result = myContract.methods.retrieveCert(tokenID).call(function (err, result) {

				if (err) { console.log(err); }
				if (result) {

					document.getElementById("mname").value = result[0];
					document.getElementById("mid").value = result[1];
					document.getElementById("mdept").value = result[2];
					document.getElementById("minst").value = result[3];
					document.getElementById("mcls").value = result[4];
					document.getElementById("missdate").value = result[5];
					document.getElementById("mholder").value = result[6];
					if (result[6] == "0x0000000000000000000000000000000000000000") {
						document.getElementById("msg2").innerHTML = "No Certificate is issued with the given ID!";
					}
					else {
						document.getElementById("msg2").innerHTML = "Here is the details!";
					}

				}

			});

		}

		// Function to call the "Modify Certificate" in Deployed Smart Contract
		function modify_cert() {

			console.log("Modifying College Competition Certificate");

			//Instantiate and connect to contract address via ABI
			var myContract = new web3.eth.Contract(cert_abi2, cert_contractAddress2, { from: account, gasPrice: '2000000000', gas: '300000' });

			var name = document.getElementById("mname").value;
			var mid = document.getElementById("mid").value;
			var dept = document.getElementById("mdept").value;
			var inst = document.getElementById("minst").value;
			var issdate = document.getElementById("missdate").value;
			var cls = document.getElementById("mcls").value;
			var address = document.getElementById("mholder").value;
			var tokenID = document.getElementById("mtokenID").value;
			// var reason = document.getElementById("mreason").value;


			//call the "update certificate" function
			var result = myContract.methods.updateCert(tokenID, name, mid, dept, inst, cls, issdate, address).send(function (err, result) {

				if (err) {
					console.log(err);
					document.getElementById("fresult").innerHTML = "Nil";
					swal({
						title: "Oops!",
						text: "Certificate cannot be modified!",
						icon: "warning",
					});
				}
				if (result) {
					var showLink = document.getElementById("etherScanLink2");
					showLink.style.display = "block";
					document.getElementById("mresult").innerHTML = result;
					swal({
						title: "Great!",
						text: "Updated Details sent to Blockchain!",
						icon: "success",
					});
				}

			});

		}


	</script>

</body>

</html>